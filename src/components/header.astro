---
import { Image } from 'astro:assets'
import pfpImage from '@/assets/carousel/pfp.webp'
import { generateSizesAndWidths } from '@/utils/image'

const navItems = [
  { href: '/', label: 'Home' },
  { href: '/#hobbies', label: 'Hobbies' },
  { href: '/#skills', label: 'Skills' },
  { href: '/#projects', label: 'Projects' },
  { href: '/journey', label: 'Journey' },
]
---

<header
  id="header"
  class="sticky top-0 z-20 flex h-fit w-full items-center justify-center bg-white/80 px-4 py-3 shadow-md backdrop-blur-md sm:h-16 md:px-6 lg:px-8"
>
  <div
    class="flex w-full max-w-5xl flex-col items-center justify-between gap-3 sm:flex-row sm:gap-0"
  >
    <a
      href="/"
      class="z-0 hidden items-center justify-center transition-transform hover:scale-110 sm:flex"
    >
      <Image
        src={pfpImage}
        alt="Shintaro Jokagi"
        class="h-10 w-10 rounded-full object-cover ring-2 ring-primary ring-offset-2 ring-offset-white"
        loading="eager"
        {...generateSizesAndWidths(pfpImage.width, pfpImage.height)}
      />
    </a>
    <nav
      id="main-nav"
      class="relative flex flex-wrap justify-center gap-4 sm:flex-nowrap sm:gap-6"
    >
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class="group relative px-2 py-1 text-sm font-medium text-gray-700 hover:text-primary data-[active=true]:font-semibold data-[active=true]:text-primary"
            data-section={
              item.href === '/'
                ? 'home'
                : item.href === '/journey'
                  ? 'journey'
                  : item.href.replace(/^\/?#/, '')
            }
            data-active="false"
          >
            {item.label}
            <span class="absolute inset-x-0 -bottom-0.5 h-0.5 origin-right scale-x-0 bg-primary transition-transform duration-300 ease-out group-hover:origin-left group-hover:scale-x-100 group-data-[journey=true]:origin-left group-data-[active=true]:scale-x-100" />
          </a>
        ))
      }
    </nav>
    <div class="hidden h-10 w-10 sm:inline"></div>
  </div>
</header>

<script>
  function updateActiveIndicator(
    activeItem: Element,
    navItems: NodeListOf<Element>
  ) {
    navItems.forEach((item) => item.setAttribute('data-active', 'false'))
    activeItem.setAttribute('data-active', 'true')
  }

  function checkActiveSection() {
    const scrollPosition = window.scrollY
    const windowHeight = window.innerHeight
    let activeSection: string | null = null

    if (window.location.pathname === '/journey') {
      activeSection = null
      document.querySelectorAll('#main-nav a').forEach((item) => {
        if ((item as HTMLAnchorElement).href.includes('/journey')) {
          console.log(item)
          item.setAttribute('data-active', 'true')
        }
      })
      return
    } else {
      document.querySelectorAll('#main-nav a').forEach((item) => {
        if ((item as HTMLAnchorElement).href === '/journey')
          item.setAttribute('data-journey', 'false')
      })
      document.querySelectorAll('section[id]').forEach((section) => {
        const sectionTop = (section as HTMLElement).offsetTop
        const sectionHeight = (section as HTMLElement).offsetHeight
        if (
          scrollPosition >= sectionTop - windowHeight / 2 &&
          scrollPosition < sectionTop + sectionHeight - windowHeight / 2
        ) {
          activeSection = section.id === 'hero' ? 'home' : section.id
        }
      })
    }

    const navItems = document.querySelectorAll('#main-nav a')
    const activeItem = Array.from(navItems).find((item) => {
      const section = item.getAttribute('data-section')
      return section === activeSection
    })
    if (activeItem) updateActiveIndicator(activeItem, navItems)
  }

  function handleResize() {
    checkActiveSection()
  }

  function initializeActiveIndicator() {
    checkActiveSection()
  }

  window.addEventListener('scroll', checkActiveSection)
  window.addEventListener('resize', handleResize)
  window.addEventListener('DOMContentLoaded', initializeActiveIndicator)

  initializeActiveIndicator()
</script>
